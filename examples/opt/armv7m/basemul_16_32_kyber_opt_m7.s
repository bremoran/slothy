.syntax unified
.cpu cortex-m4
.thumb

// void basemul_asm_opt_16_32(int32_t *, const int16_t *, const int16_t *, const int16_t *)
.global basemul_asm_opt_16_32_opt_m7
.type basemul_asm_opt_16_32_opt_m7, %function
.align 2
basemul_asm_opt_16_32_opt_m7:
  push {r4-r11, lr}

  rptr_tmp  .req r0
  aptr      .req r1
  bptr      .req r2
  aprimeptr .req r3
  poly0     .req r4
  poly1     .req r6
  poly2     .req r5
  poly3     .req r7
  q         .req r8
  qa        .req r9
  qinv      .req r10
  tmp       .req r11
  tmp2      .req r12
  loop      .req r14

  // movw qa, #26632
 // movt  q, #3329
 ### qinv=0x6ba8f301
 // movw qinv, #62209
 // movt qinv, #27560

  movw loop, #64
                                  // Instructions:    4
                                  // Expected cycles: 3
                                  // Expected IPC:    1.33
                                  //
                                  // Cycle bound:     3.0
                                  // IPC bound:       1.33
                                  //
                                  // Wall time:     0.08s
                                  // User time:     0.08s
                                  //
                                  // ----- cycle (expected) ------>
                                  // 0                        25
                                  // |------------------------|----
        ldr r11, [r2], #4         // *.............................
        ldr.w r5, [r3, #4]        // .*............................
        ldr r9, [r3], #8          // .*............................
        ldr r12, [r2], #4         // ..*...........................

                                   // ------ cycle (expected) ------>
                                   // 0                        25
                                   // |------------------------|-----
        // ldr r11, [r2], #4       // *..............................
        // ldr r12, [r2], #4       // ..*............................
        // ldr.w r5, [r3, #4]      // .*.............................
        // ldr r9, [r3], #8        // .*.............................

        sub loop, loop, #1
1:
                                   // Instructions:    14
                                   // Expected cycles: 8
                                   // Expected IPC:    1.75
                                   //
                                   // Cycle bound:     11.0
                                   // IPC bound:       1.27
                                   //
                                   // Wall time:     0.79s
                                   // User time:     0.79s
                                   //
                                   // ----- cycle (expected) ------>
                                   // 0                        25
                                   // |------------------------|----
        ldr r7, [r1], #4           // *.............................
        smuad r8, r5, r12          // *.............................
        smuad r9, r9, r11          // .*............................
        str r9, [r0], #4           // .*............................
        smuadx r4, r7, r11         // ..*...........................
        ldr r10, [r1], #4          // ..*...........................
        ldr r11, [r2], #4          // ...e..........................
        str r4, [r0], #4           // ...*..........................
        smuadx r6, r10, r12        // ....*.........................
        str r8, [r0], #4           // .....*........................
        ldr r12, [r2], #4          // .....e........................
        ldr.w r5, [r3, #4]         // ......e.......................
        str r6, [r0], #4           // .......*......................
        ldr r9, [r3], #8           // .......e......................

                                    // ------ cycle (expected) ------>
                                    // 0                        25
                                    // |------------------------|-----
        // ldr r4, [r1], #4         // .....*.......~.......~.......~.
        // ldr r6, [r2], #4         // e....'..~....'..~....'..~....'.
        // ldr r5, [r1], #4         // .....'.*.....'.~.....'.~.....'.
        // ldr r7, [r2], #4         // ..e..'....~..'....~..'....~..'.
        // ldr.w r11, [r3, #4]      // ...e.'.....~.'.....~.'.....~.'.
        // ldr r12, [r3], #8        // ....e'......~'......~'......~'.
        // smuad r12, r12, r6       // .....'*......'~......'~......'.
        // str r12, [r0], #4        // .....'*......'~......'~......'.
        // smuadx r12, r4, r6       // .....'.*.....'.~.....'.~.....'.
        // str r12, [r0], #4        // ~....'..*....'..~....'..~....'.
        // smuad r12, r11, r7       // .....*.......~.......~.......~.
        // str r12, [r0], #4        // ..~..'....*..'....~..'....~..'.
        // smuadx r12, r5, r7       // .~...'...*...'...~...'...~...'.
        // str r12, [r0], #4        // ....~'......*'......~'......~'.

        subs loop, #1
        bne 1b
                                   // Instructions:    10
                                   // Expected cycles: 8
                                   // Expected IPC:    1.25
                                   //
                                   // Cycle bound:     8.0
                                   // IPC bound:       1.25
                                   //
                                   // Wall time:     0.19s
                                   // User time:     0.19s
                                   //
                                   // ----- cycle (expected) ------>
                                   // 0                        25
                                   // |------------------------|----
        ldr r7, [r1], #4           // *.............................
        smuad r10, r5, r12         // *.............................
        smuad r5, r9, r11          // .*............................
        str r5, [r0], #4           // .*............................
        smuadx r11, r7, r11        // ..*...........................
        ldr r5, [r1], #4           // ..*...........................
        str r11, [r0], #4          // ...*..........................
        smuadx r11, r5, r12        // ....*.........................
        str r10, [r0], #4          // .....*........................
        str r11, [r0], #4          // .......*......................

                                    // ------ cycle (expected) ------>
                                    // 0                        25
                                    // |------------------------|-----
        // ldr r7, [r1], #4         // *..............................
        // smuad r8, r5, r12        // *..............................
        // smuad r9, r9, r11        // .*.............................
        // str r9, [r0], #4         // .*.............................
        // smuadx r4, r7, r11       // ..*............................
        // ldr r10, [r1], #4        // ..*............................
        // str r4, [r0], #4         // ...*...........................
        // smuadx r6, r10, r12      // ....*..........................
        // str r8, [r0], #4         // .....*.........................
        // str r6, [r0], #4         // .......*.......................


  pop {r4-r11, pc}
