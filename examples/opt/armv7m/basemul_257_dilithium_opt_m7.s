// 2
.macro barrett_32 a, Qbar, Q, tmp
    smmulr.w \tmp, \a, \Qbar
    mls.w \a, \tmp, \Q, \a
.endm

.syntax unified
.cpu cortex-m4

.align 2
.global __asm_point_mul_257_16_opt_m7
.type __asm_point_mul_257_16_opt_m7, %function
__asm_point_mul_257_16_opt_m7:
    push.w {r4-r11, lr}

    ldr.w r14, [sp, #36]

    .equ width, 4

    add.w r12, r14, #64*width
                                      // Instructions:    12
                                      // Expected cycles: 7
                                      // Expected IPC:    1.71
                                      //
                                      // Wall time:     0.14s
                                      // User time:     0.14s
                                      //
                                      // ----- cycle (expected) ------>
                                      // 0                        25
                                      // |------------------------|----
        ldr.w r10, [r1, #2*4]         // *.............................
        ldr.w r11, [r14, #1*4]        // *.............................
        ldr.w r5, [r1, #3*4]          // .*............................
        smultb r6, r10, r11           // ..*...........................
        neg.w r11, r11                // ..*...........................
        smultb r7, r5, r11            // ...*..........................
        ldr.w r9, [r1, #1*4]          // ...*..........................
        smmulr.w r8, r6, r2           // ....*.........................
        smmulr.w r4, r7, r2           // .....*........................
        ldr.w r11, [r14], #2*4        // .....*........................
        mls.w r8, r8, r3, r6          // ......*.......................
        ldr.w r6, [r1], #4*4          // ......*.......................

                                       // ------ cycle (expected) ------>
                                       // 0                        25
                                       // |------------------------|-----
        // ldr.w r10, [r1, #2*4]       // *..............................
        // ldr.w r5, [r1, #3*4]        // .*.............................
        // ldr.w r7, [r14, #1*4]       // *..............................
        // smultb r8, r10, r7          // ..*............................
        // neg.w r7, r7                // ..*............................
        // smultb r7, r5, r7           // ...*...........................
        // ldr.w r9, [r1, #1*4]        // ...*...........................
        // smmulr.w r6, r8, r2         // ....*..........................
        // smmulr.w r4, r7, r2         // .....*.........................
        // mls.w r8, r6, r3, r8        // ......*........................
        // ldr.w r6, [r1], #4*4        // ......*........................
        // ldr.w r11, [r14], #2*4      // .....*.........................

1:
                                           // Instructions:    28
                                           // Expected cycles: 15
                                           // Expected IPC:    1.87
                                           //
                                           // Wall time:     24.31s
                                           // User time:     24.31s
                                           //
                                           // ----- cycle (expected) ------>
                                           // 0                        25
                                           // |------------------------|----
        mls.w r4, r4, r3, r7               // *.............................
        smultb r7, r6, r11                 // .*............................
        neg.w r11, r11                     // .*............................
        pkhbt r4, r5, r4, lsl #16          // ..*...........................
        smultb r5, r9, r11                 // ..*...........................
        pkhbt r11, r10, r8, lsl #16        // ...*..........................
        smmulr.w r10, r7, r2               // ...*..........................
        smmulr.w r8, r5, r2                // ....*.........................
        mls.w r7, r10, r3, r7              // .....*........................
        ldr.w r10, [r1, #2*4]              // .....e........................
        mls.w r8, r8, r3, r5               // ......*.......................
        ldr.w r5, [r1, #3*4]               // ......e.......................
        pkhbt r6, r6, r7, lsl #16          // .......*......................
        ldr.w r7, [r14, #1*4]              // .......e......................
        pkhbt r8, r9, r8, lsl #16          // ........*.....................
        str.w r8, [r0, #1*4]               // ........*.....................
        smultb r8, r10, r7                 // .........e....................
        neg.w r7, r7                       // .........e....................
        str.w r6, [r0], #2*4               // ..........*...................
        smultb r7, r5, r7                  // ..........e...................
        ldr.w r9, [r1, #1*4]               // ...........e..................
        smmulr.w r6, r8, r2                // ...........e..................
        str.w r4, [r0, #1*4]               // ............*.................
        smmulr.w r4, r7, r2                // ............e.................
        mls.w r8, r6, r3, r8               // .............e................
        ldr.w r6, [r1], #4*4               // .............e................
        str.w r11, [r0], #2*4              // ..............*...............
        ldr.w r11, [r14], #2*4             // ..............e...............

                                           // ------ cycle (expected) ------>
                                           // 0                        25
                                           // |------------------------|-----
        // ldr.w r7, [r1, #2*4]            // e.........'....~.........'.....
        // ldr.w r8, [r1, #3*4]            // .e........'.....~........'.....
        // ldr.w r9, [r14, #1*4]           // ..e.......'......~.......'.....
        // ldr.w r5, [r1, #1*4]            // ......e...'..........~...'.....
        // ldr.w r4, [r1], #4*4            // ........e.'............~.'.....
        // ldr.w r6, [r14], #2*4           // .........e'.............~'.....
        // smultb r10, r4, r6              // ..........'*.............'~....
        // smmulr.w r11, r10, r2           // ..........'..*...........'..~..
        // mls.w r10, r11, r3, r10         // ~.........'....*.........'.....
        // pkhbt r4, r4, r10, lsl #16      // ..~.......'......*.......'.....
        // neg.w r6, r6                    // ..........'*.............'~....
        // smultb r10, r5, r6              // ..........'.*............'.~...
        // smmulr.w r11, r10, r2           // ..........'...*..........'...~.
        // mls.w r10, r11, r3, r10         // .~........'.....*........'.....
        // pkhbt r5, r5, r10, lsl #16      // ...~......'.......*......'.....
        // str.w r5, [r0, #1*4]            // ...~......'.......*......'.....
        // str.w r4, [r0], #2*4            // .....~....'.........*....'.....
        // smultb r10, r7, r9              // ....e.....'........~.....'.....
        // smmulr.w r11, r10, r2           // ......e...'..........~...'.....
        // mls.w r10, r11, r3, r10         // ........e.'............~.'.....
        // pkhbt r7, r7, r10, lsl #16      // ..........'..*...........'..~..
        // neg.w r9, r9                    // ....e.....'........~.....'.....
        // smultb r10, r8, r9              // .....e....'.........~....'.....
        // smmulr.w r11, r10, r2           // .......e..'...........~..'.....
        // mls.w r10, r11, r3, r10         // ..........*..............~.....
        // pkhbt r8, r8, r10, lsl #16      // ..........'.*............'.~...
        // str.w r8, [r0, #1*4]            // .......~..'...........*..'.....
        // str.w r7, [r0], #2*4            // .........~'.............*'.....

        cmp r14, r12
        bne 1b
                                           // Instructions:    16
                                           // Expected cycles: 15
                                           // Expected IPC:    1.07
                                           //
                                           // Wall time:     0.16s
                                           // User time:     0.16s
                                           //
                                           // ----- cycle (expected) ------>
                                           // 0                        25
                                           // |------------------------|----
        pkhbt r8, r10, r8, lsl #16         // *.............................
        smultb r10, r6, r11                // *.............................
        mls.w r4, r4, r3, r7               // .*............................
        neg.w r11, r11                     // .*............................
        smultb r7, r9, r11                 // ..*...........................
        pkhbt r4, r5, r4, lsl #16          // ...*..........................
        smmulr.w r5, r10, r2               // ...*..........................
        smmulr.w r11, r7, r2               // ....*.........................
        mls.w r10, r5, r3, r10             // .....*........................
        mls.w r11, r11, r3, r7             // ......*.......................
        pkhbt r10, r6, r10, lsl #16        // .......*......................
        pkhbt r11, r9, r11, lsl #16        // ........*.....................
        str.w r11, [r0, #1*4]              // ........*.....................
        str.w r10, [r0], #2*4              // ..........*...................
        str.w r4, [r0, #1*4]               // ............*.................
        str.w r8, [r0], #2*4               // ..............*...............

                                            // ------ cycle (expected) ------>
                                            // 0                        25
                                            // |------------------------|-----
        // mls.w r4, r4, r3, r7             // .*.............................
        // smultb r7, r6, r11               // *..............................
        // neg.w r11, r11                   // .*.............................
        // pkhbt r4, r5, r4, lsl #16        // ...*...........................
        // smultb r5, r9, r11               // ..*............................
        // pkhbt r11, r10, r8, lsl #16      // *..............................
        // smmulr.w r10, r7, r2             // ...*...........................
        // smmulr.w r8, r5, r2              // ....*..........................
        // mls.w r7, r10, r3, r7            // .....*.........................
        // mls.w r8, r8, r3, r5             // ......*........................
        // pkhbt r6, r6, r7, lsl #16        // .......*.......................
        // pkhbt r8, r9, r8, lsl #16        // ........*......................
        // str.w r8, [r0, #1*4]             // ........*......................
        // str.w r6, [r0], #2*4             // ..........*....................
        // str.w r4, [r0, #1*4]             // ............*..................
        // str.w r11, [r0], #2*4            // ..............*................


    pop.w {r4-r11, pc}
