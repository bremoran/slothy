.syntax unified
.thumb
.macro redq a, tmp, q
    add     \tmp, \a,  #4194304
    asrs    \tmp, \tmp, #23
    mls     \a, \tmp, \q, \a
.endm

// void asm_reduce32(int32_t a[N]);
.global pqcrystals_dilithium_asm_reduce32_opt_m7
.type pqcrystals_dilithium_asm_reduce32_opt_m7, %function
.align 2
pqcrystals_dilithium_asm_reduce32_opt_m7:
    push {r4-r11, r14}

    movw r12,#:lower16:8380417
    movt r12,#:upper16:8380417
    movw r10, #32
                // Instructions:    0
                // Expected cycles: 0
                // Expected IPC:    0.00
                //
                // Wall time:     0.00s
                // User time:     0.00s
                //
1:
                                     // Instructions:    41
                                     // Expected cycles: 21
                                     // Expected IPC:    1.95
                                     //
                                     // Wall time:     6.10s
                                     // User time:     6.10s
                                     //
                                     // ----- cycle (expected) ------>
                                     // 0                        25
                                     // |------------------------|----
        ldr.w r2, [r0, #28]          // *.............................
        ldr.w r14, [r0]              // *.............................
        add r8, r2, #4194304         // .*............................
        ldr.w r11, [r0, #4]          // .*............................
        asrs r3, r8, #23             // ..*...........................
        add r4, r11, #4194304        // ..*...........................
        add r7, r14, #4194304        // ...*..........................
        mls r6, r3, r12, r2          // ...*..........................
        str.w r6, [r0, #28]          // ....*.........................
        ldr.w r1, [r0, #8]           // ....*.........................
        asrs r2, r4, #23             // .....*........................
        asrs r7, r7, #23             // .....*........................
        mls r14, r7, r12, r14        // ......*.......................
        add r4, r1, #4194304         // ......*.......................
        ldr.w r7, [r0, #20]          // .......*......................
        asrs r3, r4, #23             // .......*......................
        add r4, r7, #4194304         // ........*.....................
        mls r1, r3, r12, r1          // ........*.....................
        str r14, [r0], #8*4          // .........*....................
        ldr.w r8, [r0, #-8]          // .........*....................
        add r14, r8, #4194304        // ..........*...................
        mls r3, r2, r12, r11         // ..........*...................
        asrs r4, r4, #23             // ...........*..................
        str.w r3, [r0, #-28]         // ...........*..................
        mls r2, r4, r12, r7          // ............*.................
        asrs r9, r14, #23            // ............*.................
        mls r8, r9, r12, r8          // .............*................
        ldr.w r3, [r0, #-16]         // .............*................
        ldr.w r11, [r0, #-20]        // ..............*...............
        str.w r2, [r0, #-12]         // ..............*...............
        str.w r1, [r0, #-24]         // ...............*..............
        add r9, r3, #4194304         // ...............*..............
        asrs r2, r9, #23             // ................*.............
        str.w r8, [r0, #-8]          // ................*.............
        add r7, r11, #4194304        // .................*............
        mls r5, r2, r12, r3          // .................*............
        str.w r5, [r0, #-16]         // ..................*...........
        asrs r4, r7, #23             // ..................*...........
        mls r9, r4, r12, r11         // ...................*..........
        subs r10, #1                 // ...................*..........
        str.w r9, [r0, #-20]         // ....................*.........

                                          // ------ cycle (expected) ------>
                                          // 0                        25
                                          // |------------------------|-----
        // ldr.w r1, [r0]                 // *....................~.........
        // ldr.w r2, [r0, #1*4]           // .*...................'~........
        // ldr.w r3, [r0, #2*4]           // ....*................'...~.....
        // ldr.w r4, [r0, #3*4]           // ..............*......'.........
        // ldr.w r5, [r0, #4*4]           // .............*.......'.........
        // ldr.w r6, [r0, #5*4]           // .......*.............'......~..
        // ldr.w r7, [r0, #6*4]           // .........*...........'.........
        // ldr.w r8, [r0, #7*4]           // *....................~.........
        // add     r9, r1,  #4194304      // ...*.................'..~......
        // asrs    r9, r9, #23            // .....*...............'....~....
        // mls     r1, r9, r12, r1        // ......*..............'.....~...
        // add     r9, r2,  #4194304      // ..*..................'.~.......
        // asrs    r9, r9, #23            // .....*...............'....~....
        // mls     r2, r9, r12, r2        // ..........*..........'.........
        // add     r9, r3,  #4194304      // ......*..............'.....~...
        // asrs    r9, r9, #23            // .......*.............'......~..
        // mls     r3, r9, r12, r3        // ........*............'.......~.
        // add     r9, r4,  #4194304      // .................*...'.........
        // asrs    r9, r9, #23            // ..................*..'.........
        // mls     r4, r9, r12, r4        // ...................*.'.........
        // add     r9, r5,  #4194304      // ...............*.....'.........
        // asrs    r9, r9, #23            // ................*....'.........
        // mls     r5, r9, r12, r5        // .................*...'.........
        // add     r9, r6,  #4194304      // ........*............'.......~.
        // asrs    r9, r9, #23            // ...........*.........'.........
        // mls     r6, r9, r12, r6        // ............*........'.........
        // add     r9, r7,  #4194304      // ..........*..........'.........
        // asrs    r9, r9, #23            // ............*........'.........
        // mls     r7, r9, r12, r7        // .............*.......'.........
        // add     r9, r8,  #4194304      // .*...................'~........
        // asrs    r9, r9, #23            // ..*..................'.~.......
        // mls     r8, r9, r12, r8        // ...*.................'..~......
        // str.w r2, [r0, #1*4]           // ...........*.........'.........
        // str.w r3, [r0, #2*4]           // ...............*.....'.........
        // str.w r4, [r0, #3*4]           // ....................*'.........
        // str.w r5, [r0, #4*4]           // ..................*..'.........
        // str.w r6, [r0, #5*4]           // ..............*......'.........
        // str.w r7, [r0, #6*4]           // ................*....'.........
        // str.w r8, [r0, #7*4]           // ....*................'...~.....
        // str r1, [r0], #8*4             // .........*...........'.........
        // subs r10, #1                   // ...................*.'.........

        bne 1b
                // Instructions:    0
                // Expected cycles: 0
                // Expected IPC:    0.00
                //
                // Wall time:     0.00s
                // User time:     0.00s
                //

    pop {r4-r11, r14}
    bx lr
