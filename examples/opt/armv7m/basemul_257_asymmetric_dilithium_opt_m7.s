// 2
.macro barrett_32 a, Qbar, Q, tmp
    smmulr \tmp, \a, \Qbar
    mls \a, \tmp, \Q, \a
.endm

.syntax unified
.cpu cortex-m4

.align 2
.global __asm_asymmetric_mul_257_16_opt_m7
.type __asm_asymmetric_mul_257_16_opt_m7, %function
__asm_asymmetric_mul_257_16_opt_m7:
    push.w {r4-r11, lr}

    .equ width, 4

    add.w r12, r0, #256*width
                                    // Instructions:    6
                                    // Expected cycles: 4
                                    // Expected IPC:    1.50
                                    //
                                    // Wall time:     0.01s
                                    // User time:     0.01s
                                    //
                                    // ----- cycle (expected) ------>
                                    // 0                        25
                                    // |------------------------|----
        ldr.w r10, [r1, #4]         // *.............................
        ldr.w r6, [r1], #2*4        // *.............................
        ldr.w r4, [r2, #4]          // .*............................
        ldr.w r11, [r3, #4]         // ..*...........................
        ldr.w r9, [r3], #2*4        // ...*..........................
        smuadx r4, r10, r4          // ...*..........................

                                     // ------ cycle (expected) ------>
                                     // 0                        25
                                     // |------------------------|-----
        // ldr.w r10, [r1, #4]       // *..............................
        // ldr.w r8, [r2, #4]        // .*.............................
        // ldr.w r11, [r3, #4]       // ..*............................
        // ldr.w r9, [r3], #2*4      // ...*...........................
        // ldr.w r6, [r1], #2*4      // *..............................
        // smuadx r4, r10, r8        // ...*...........................

        sub r12, r12, #16
_asymmetric_mul_16_loop:
                                     // Instructions:    15
                                     // Expected cycles: 8
                                     // Expected IPC:    1.88
                                     //
                                     // Wall time:     0.18s
                                     // User time:     0.18s
                                     //
                                     // ----- cycle (expected) ------>
                                     // 0                        25
                                     // |------------------------|----
        smuad r5, r10, r11           // *.............................
        ldr.w r11, [r2], #2*4        // *.............................
        smuad r7, r6, r9             // .*............................
        ldr.w r10, [r1, #4]          // .e............................
        smuadx r9, r6, r11           // ..*...........................
        ldr.w r8, [r2, #4]           // ..e...........................
        ldr.w r11, [r3, #4]          // ...e..........................
        str.w r9, [r0, #4]           // ...*..........................
        ldr.w r9, [r3], #2*4         // ....e.........................
        str.w r7, [r0], #2*4         // ....*......................... // @slothy:core
        ldr.w r6, [r1], #2*4         // .....e........................
        str.w r4, [r0, #4]           // .....*........................
        str.w r5, [r0], #2*4         // ......*....................... // @slothy:core
        cmp.w r0, r12                // .......*......................
        smuadx r4, r10, r8           // .......e......................

                                       // ------ cycle (expected) ------>
                                       // 0                        25
                                       // |------------------------|-----
        // ldr.w r7, [r1, #4]          // e......'~......'~......'~......
        // ldr.w r4, [r1], #2*4        // ....e..'....~..'....~..'....~..
        // ldr.w r8, [r2, #4]          // .e.....'.~.....'.~.....'.~.....
        // ldr.w r5, [r2], #2*4        // .......*.......~.......~.......
        // ldr.w r9, [r3, #4]          // ..e....'..~....'..~....'..~....
        // ldr.w r6, [r3], #2*4        // ...e...'...~...'...~...'...~...
        // smuad r10, r4, r6           // ~......'*......'~......'~......
        // smuadx r11, r4, r5          // .~.....'.*.....'.~.....'.~.....
        // str.w r11, [r0, #4]         // ..~....'..*....'..~....'..~....
        // str.w r10, [r0], #2*4       // ...~...'...*...'...~...'...~...
        // smuad r10, r7, r9           // .......*.......~.......~.......
        // smuadx r11, r7, r8          // ......e'......~'......~'.......
        // str.w r11, [r0, #4]         // ....~..'....*..'....~..'....~..
        // str.w r10, [r0], #2*4       // .....~.'.....*.'.....~.'.....~.
        // cmp.w r0, r12               // ......~'......*'......~'.......

        bne _asymmetric_mul_16_loop
                                     // Instructions:    9
                                     // Expected cycles: 8
                                     // Expected IPC:    1.12
                                     //
                                     // Wall time:     0.01s
                                     // User time:     0.01s
                                     //
                                     // ----- cycle (expected) ------>
                                     // 0                        25
                                     // |------------------------|----
        ldr.w r5, [r2], #2*4         // *.............................
        smuad r8, r6, r9             // *.............................
        smuad r11, r10, r11          // .*............................
        smuadx r6, r6, r5            // ..*...........................
        str.w r6, [r0, #4]           // ...*..........................
        str.w r8, [r0], #2*4         // ....*......................... // @slothy:core
        str.w r4, [r0, #4]           // .....*........................
        str.w r11, [r0], #2*4        // ......*....................... // @slothy:core
        cmp.w r0, r12                // .......*......................

                                      // ------ cycle (expected) ------>
                                      // 0                        25
                                      // |------------------------|-----
        // smuad r5, r10, r11         // .*.............................
        // ldr.w r11, [r2], #2*4      // *..............................
        // smuad r7, r6, r9           // *..............................
        // smuadx r9, r6, r11         // ..*............................
        // str.w r9, [r0, #4]         // ...*...........................
        // str.w r7, [r0], #2*4       // ....*..........................
        // str.w r4, [r0, #4]         // .....*.........................
        // str.w r5, [r0], #2*4       // ......*........................
        // cmp.w r0, r12              // .......*.......................


    pop.w {r4-r11, pc}

.size __asm_asymmetric_mul_257_16_opt_m7, .-__asm_asymmetric_mul_257_16_opt_m7