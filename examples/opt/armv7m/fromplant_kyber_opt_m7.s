/******************************************************************************
* Integrating the improved Plantard arithmetic into Kyber.
*
* Efficient Plantard arithmetic enables a faster Kyber implementation with the
* same stack usage.
*
* See the paper at https:// eprint.iacr.org/2022/956.pdf for more details.
*
* @author   Junhao Huang, BNU-HKBU United International College, Zhuhai, China
*           jhhuang_nuaa@126.com
*
* @date     September 2022
******************************************************************************/

.macro doubleplant a, tmp, q, qa, plantconst
 smulwb \tmp, \plantconst, \a
 smulwt \a, \plantconst, \a
 smlabt \tmp, \tmp, \q, \qa
 smlabt \a, \a, \q, \qa
 pkhtb \a, \a, \tmp, asr #16
.endm

.syntax unified
.cpu cortex-m4
.thumb

.global asm_fromplant_opt_m7
.type asm_fromplant_opt_m7,%function
.align 2
asm_fromplant_opt_m7:
 push    {r4-r11, r14}

 poly        .req r0
 poly0       .req r1
 poly1       .req r2
 poly2       .req r3
 poly3       .req r4
 poly4       .req r5
 poly5       .req r6
 poly6       .req r7
 poly7       .req r8
 loop        .req r9
 plantconst  .req r10
 q           .req r11
 qa          .req r12
 tmp         .req r14

 movw qa, #26632
 movt q, #3329

 ### movt qinv, #3327
 ### plant_constant=(Plant_const^2%M)*(p^-1) % 2^32
 movw plantconst, #20396
 movt plantconst, #38900
 movw loop, #16
                                 // Instructions:    1
                                 // Expected cycles: 1
                                 // Expected IPC:    1.00
                                 //
                                 // Cycle bound:     1.0
                                 // IPC bound:       1.00
                                 //
                                 // Wall time:     0.00s
                                 // User time:     0.00s
                                 //
                                 // ----- cycle (expected) ------>
                                 // 0                        25
                                 // |------------------------|----
        ldr r3, [r0, #16]        // *.............................

                                  // ------ cycle (expected) ------>
                                  // 0                        25
                                  // |------------------------|-----
        // ldr r3, [r0, #16]      // *..............................

        sub r9, r9, #1
1:
                                           // Instructions:    57
                                           // Expected cycles: 40
                                           // Expected IPC:    1.43
                                           //
                                           // Cycle bound:     30.0
                                           // IPC bound:       1.90
                                           //
                                           // Wall time:     10.56s
                                           // User time:     10.56s
                                           //
                                           // ---------- cycle (expected) ----------->
                                           // 0                        25
                                           // |------------------------|--------------
        ldr r5, [r0, #24]                  // *.......................................
        smulwt r8, r10, r3                 // *.......................................
        subs.w r9, #1                      // .*......................................
        smulwb r2, r10, r3                 // .*......................................
        ldr r3, [r0, #8]                   // ..*.....................................
        smlabt r14, r8, r11, r12           // ..*.....................................
        ldr r4, [r0, #20]                  // ...*....................................
        smulwb r8, r10, r5                 // ...*....................................
        smulwb r6, r10, r3                 // ....*...................................
        smulwt r1, r10, r5                 // .....*..................................
        ldr r5, [r0, #28]                  // ......*.................................
        smlabt r7, r8, r11, r12            // ......*.................................
        smlabt r1, r1, r11, r12            // .......*................................
        smlabt r6, r6, r11, r12            // ........*...............................
        smulwb r8, r10, r5                 // .........*..............................
        pkhtb r1, r1, r7, asr #16          // ..........*.............................
        smulwt r7, r10, r3                 // ..........*.............................
        str r1, [r0, #24]                  // ...........*............................
        smlabt r3, r7, r11, r12            // ............*...........................
        smlabt r7, r8, r11, r12            // .............*..........................
        pkhtb r3, r3, r6, asr #16          // ..............*.........................
        smulwb r8, r10, r4                 // ..............*.........................
        str r3, [r0, #8]                   // ...............*........................
        ldr r3, [r0, #0]                   // ...............*........................
        smulwt r6, r10, r4                 // ................*.......................
        smulwt r1, r10, r3                 // .................*......................
        smulwb r3, r10, r3                 // ..................*.....................
        smulwt r5, r10, r5                 // ...................*....................
        smlabt r4, r3, r11, r12            // ....................*...................
        ldr r3, [r0, #12]                  // .....................*..................
        smlabt r5, r5, r11, r12            // .....................*..................
        smlabt r6, r6, r11, r12            // ......................*.................
        smlabt r8, r8, r11, r12            // .......................*................
        pkhtb r5, r5, r7, asr #16          // ........................*...............
        smulwb r7, r10, r3                 // ........................*...............
        str r5, [r0, #28]                  // .........................*..............
        pkhtb r6, r6, r8, asr #16          // ..........................*.............
        smlabt r8, r7, r11, r12            // ..........................*.............
        smulwt r5, r10, r3                 // ...........................*............
        str r6, [r0, #20]                  // ............................*...........
        ldr r3, [r0, #4]                   // ............................*...........
        smlabt r2, r2, r11, r12            // .............................*..........
        smulwt r6, r10, r3                 // ..............................*.........
        smulwb r7, r10, r3                 // ...............................*........
        pkhtb r14, r14, r2, asr #16        // ................................*.......
        smlabt r5, r5, r11, r12            // ................................*.......
        ldr r3, [r0, #48]                  // .................................e......
        smlabt r7, r7, r11, r12            // .................................*......
        pkhtb r5, r5, r8, asr #16          // ..................................*.....
        smlabt r1, r1, r11, r12            // ..................................*.....
        smlabt r6, r6, r11, r12            // ...................................*....
        pkhtb r4, r1, r4, asr #16          // ....................................*...
        str r4, [r0], #32                  // ....................................*...
        pkhtb r1, r6, r7, asr #16          // .....................................*..
        str r5, [r0, #-20]                 // .....................................*..
        str r1, [r0, #-28]                 // ......................................*.
        str r14, [r0, #-16]                // .......................................*

                                           // -------------- cycle (expected) -------------->
                                           // 0                        25
                                           // |------------------------|---------------------
        // ldr r1, [r0, #0]                // .......'..............*........................
        // ldr r2, [r0, #4]                // .......'...........................*...........
        // ldr r3, [r0, #8]                // .......'.*.....................................
        // ldr r4, [r0, #12]               // .......'....................*..................
        // ldr r5, [r0, #16]               // e......'................................~......
        // ldr r6, [r0, #20]               // .......'..*....................................
        // ldr r7, [r0, #24]               // .......*.......................................
        // ldr r8, [r0, #28]               // .......'.....*.................................
        // smulwb r14, r10, r1             // .......'.................*.....................
        // smulwt r1, r10, r1              // .......'................*......................
        // smlabt r14, r14, r11, r12       // .......'...................*...................
        // smlabt r1, r1, r11, r12         // .~.....'.................................*.....
        // pkhtb r1, r1, r14, asr #16      // ...~...'...................................*...
        // smulwb r14, r10, r2             // .......'..............................*........
        // smulwt r2, r10, r2              // .......'.............................*.........
        // smlabt r14, r14, r11, r12       // ~......'................................*......
        // smlabt r2, r2, r11, r12         // ..~....'..................................*....
        // pkhtb r2, r2, r14, asr #16      // ....~..'....................................*..
        // smulwb r14, r10, r3             // .......'...*...................................
        // smulwt r3, r10, r3              // .......'.........*.............................
        // smlabt r14, r14, r11, r12       // .......'.......*...............................
        // smlabt r3, r3, r11, r12         // .......'...........*...........................
        // pkhtb r3, r3, r14, asr #16      // .......'.............*.........................
        // smulwb r14, r10, r4             // .......'.......................*...............
        // smulwt r4, r10, r4              // .......'..........................*............
        // smlabt r14, r14, r11, r12       // .......'.........................*.............
        // smlabt r4, r4, r11, r12         // .......'...............................*.......
        // pkhtb r4, r4, r14, asr #16      // .~.....'.................................*.....
        // smulwb r14, r10, r5             // .......'*......................................
        // smulwt r5, r10, r5              // .......*.......................................
        // smlabt r14, r14, r11, r12       // .......'............................*..........
        // smlabt r5, r5, r11, r12         // .......'.*.....................................
        // pkhtb r5, r5, r14, asr #16      // .......'...............................*.......
        // smulwb r14, r10, r6             // .......'.............*.........................
        // smulwt r6, r10, r6              // .......'...............*.......................
        // smlabt r14, r14, r11, r12       // .......'......................*................
        // smlabt r6, r6, r11, r12         // .......'.....................*.................
        // pkhtb r6, r6, r14, asr #16      // .......'.........................*.............
        // smulwb r14, r10, r7             // .......'..*....................................
        // smulwt r7, r10, r7              // .......'....*..................................
        // smlabt r14, r14, r11, r12       // .......'.....*.................................
        // smlabt r7, r7, r11, r12         // .......'......*................................
        // pkhtb r7, r7, r14, asr #16      // .......'.........*.............................
        // smulwb r14, r10, r8             // .......'........*..............................
        // smulwt r8, r10, r8              // .......'..................*....................
        // smlabt r14, r14, r11, r12       // .......'............*..........................
        // smlabt r8, r8, r11, r12         // .......'....................*..................
        // pkhtb r8, r8, r14, asr #16      // .......'.......................*...............
        // str r8, [r0, #28]               // .......'........................*..............
        // str r7, [r0, #24]               // .......'..........*............................
        // str r6, [r0, #20]               // .......'...........................*...........
        // str r5, [r0, #16]               // ......~'......................................*
        // str r4, [r0, #12]               // ....~..'....................................*..
        // str r3, [r0, #8]                // .......'..............*........................
        // str r2, [r0, #4]                // .....~.'.....................................*.
        // str r1, [r0], #32               // ...~...'...................................*...
        // subs.w r9, #1                   // .......'*......................................

        bne 1b
                                           // Instructions:    56
                                           // Expected cycles: 40
                                           // Expected IPC:    1.40
                                           //
                                           // Cycle bound:     40.0
                                           // IPC bound:       1.40
                                           //
                                           // Wall time:     2.60s
                                           // User time:     2.60s
                                           //
                                           // ---------- cycle (expected) ----------->
                                           // 0                        25
                                           // |------------------------|--------------
        ldr r5, [r0, #12]                  // *.......................................
        smulwt r14, r10, r3                // *.......................................
        ldr r1, [r0, #24]                  // .*......................................
        smulwb r4, r10, r3                 // .*......................................
        subs.w r9, #1                      // ..*.....................................
        smulwb r7, r10, r5                 // ..*.....................................
        ldr r2, [r0, #20]                  // ...*....................................
        smulwt r5, r10, r5                 // ...*....................................
        ldr r6, [r0, #4]                   // ....*...................................
        smlabt r3, r7, r11, r12            // ....*...................................
        ldr r8, [r0, #0]                   // .....*..................................
        smlabt r7, r5, r11, r12            // .....*..................................
        smulwt r5, r10, r6                 // ......*.................................
        pkhtb r7, r7, r3, asr #16          // .......*................................
        str r7, [r0, #12]                  // .......*................................
        ldr r7, [r0, #28]                  // ........*...............................
        smlabt r5, r5, r11, r12            // ........*...............................
        smlabt r4, r4, r11, r12            // .........*..............................
        smlabt r3, r14, r11, r12           // ..........*.............................
        smulwb r14, r10, r2                // ...........*............................
        pkhtb r4, r3, r4, asr #16          // ............*...........................
        smulwt r2, r10, r2                 // ............*...........................
        smlabt r14, r14, r11, r12          // .............*..........................
        smlabt r2, r2, r11, r12            // ..............*.........................
        smulwt r3, r10, r7                 // ...............*........................
        pkhtb r2, r2, r14, asr #16         // ................*.......................
        str r2, [r0, #20]                  // ................*.......................
        smlabt r3, r3, r11, r12            // .................*......................
        smulwt r14, r10, r8                // ..................*.....................
        smulwb r8, r10, r8                 // ...................*....................
        smlabt r14, r14, r11, r12          // ....................*...................
        smlabt r2, r8, r11, r12            // .....................*..................
        smulwb r8, r10, r1                 // ......................*.................
        smulwt r1, r10, r1                 // .......................*................
        pkhtb r14, r14, r2, asr #16        // ........................*...............
        str r14, [r0], #32                 // ........................*...............
        smlabt r8, r8, r11, r12            // .........................*..............
        ldr r14, [r0, #-24]                // ..........................*.............
        smlabt r2, r1, r11, r12            // ..........................*.............
        str r4, [r0, #-16]                 // ...........................*............
        pkhtb r2, r2, r8, asr #16          // ............................*...........
        smulwb r4, r10, r14                // ............................*...........
        str r2, [r0, #-8]                  // .............................*..........
        smulwt r14, r10, r14               // ..............................*.........
        smulwb r7, r10, r7                 // ...............................*........
        smulwb r6, r10, r6                 // ................................*.......
        smlabt r7, r7, r11, r12            // .................................*......
        smlabt r2, r4, r11, r12            // ..................................*.....
        smlabt r4, r6, r11, r12            // ...................................*....
        pkhtb r3, r3, r7, asr #16          // ....................................*...
        str r3, [r0, #-4]                  // ....................................*...
        smlabt r3, r14, r11, r12           // .....................................*..
        pkhtb r1, r5, r4, asr #16          // ......................................*.
        str r1, [r0, #-28]                 // ......................................*.
        pkhtb r14, r3, r2, asr #16         // .......................................*
        str r14, [r0, #-24]                // .......................................*

                                            // ---------- cycle (expected) ----------->
                                            // 0                        25
                                            // |------------------------|--------------
        // ldr r5, [r0, #24]                // .*......................................
        // smulwt r8, r10, r3               // *.......................................
        // subs.w r9, #1                    // ..*.....................................
        // smulwb r2, r10, r3               // .*......................................
        // ldr r3, [r0, #8]                 // ..........................*.............
        // smlabt r14, r8, r11, r12         // ..........*.............................
        // ldr r4, [r0, #20]                // ...*....................................
        // smulwb r8, r10, r5               // ......................*.................
        // smulwb r6, r10, r3               // ............................*...........
        // smulwt r1, r10, r5               // .......................*................
        // ldr r5, [r0, #28]                // ........*...............................
        // smlabt r7, r8, r11, r12          // .........................*..............
        // smlabt r1, r1, r11, r12          // ..........................*.............
        // smlabt r6, r6, r11, r12          // ..................................*.....
        // smulwb r8, r10, r5               // ...............................*........
        // pkhtb r1, r1, r7, asr #16        // ............................*...........
        // smulwt r7, r10, r3               // ..............................*.........
        // str r1, [r0, #24]                // .............................*..........
        // smlabt r3, r7, r11, r12          // .....................................*..
        // smlabt r7, r8, r11, r12          // .................................*......
        // pkhtb r3, r3, r6, asr #16        // .......................................*
        // smulwb r8, r10, r4               // ...........*............................
        // str r3, [r0, #8]                 // .......................................*
        // ldr r3, [r0, #0]                 // .....*..................................
        // smulwt r6, r10, r4               // ............*...........................
        // smulwt r1, r10, r3               // ..................*.....................
        // smulwb r3, r10, r3               // ...................*....................
        // smulwt r5, r10, r5               // ...............*........................
        // smlabt r4, r3, r11, r12          // .....................*..................
        // ldr r3, [r0, #12]                // *.......................................
        // smlabt r5, r5, r11, r12          // .................*......................
        // smlabt r6, r6, r11, r12          // ..............*.........................
        // smlabt r8, r8, r11, r12          // .............*..........................
        // pkhtb r5, r5, r7, asr #16        // ....................................*...
        // smulwb r7, r10, r3               // ..*.....................................
        // str r5, [r0, #28]                // ....................................*...
        // pkhtb r6, r6, r8, asr #16        // ................*.......................
        // smlabt r8, r7, r11, r12          // ....*...................................
        // smulwt r5, r10, r3               // ...*....................................
        // str r6, [r0, #20]                // ................*.......................
        // ldr r3, [r0, #4]                 // ....*...................................
        // smlabt r2, r2, r11, r12          // .........*..............................
        // smulwt r6, r10, r3               // ......*.................................
        // smulwb r7, r10, r3               // ................................*.......
        // pkhtb r14, r14, r2, asr #16      // ............*...........................
        // smlabt r5, r5, r11, r12          // .....*..................................
        // smlabt r7, r7, r11, r12          // ...................................*....
        // pkhtb r5, r5, r8, asr #16        // .......*................................
        // smlabt r1, r1, r11, r12          // ....................*...................
        // smlabt r6, r6, r11, r12          // ........*...............................
        // pkhtb r4, r1, r4, asr #16        // ........................*...............
        // str r4, [r0], #32                // ........................*...............
        // pkhtb r1, r6, r7, asr #16        // ......................................*.
        // str r5, [r0, #-20]               // .......*................................
        // str r1, [r0, #-28]               // ......................................*.
        // str r14, [r0, #-16]              // ...........................*............


 .unreq poly
 .unreq poly0
 .unreq poly1
 .unreq poly2
 .unreq poly3
 .unreq poly4
 .unreq poly5
 .unreq poly6
 .unreq poly7
 .unreq loop
 .unreq plantconst
 .unreq q
 .unreq qa
 .unreq tmp
 pop     {r4-r11, pc}

.size asm_fromplant_opt_m7, .-asm_fromplant_opt_m7