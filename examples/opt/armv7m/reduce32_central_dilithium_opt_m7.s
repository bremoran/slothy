.syntax unified
.thumb

.macro barrett_32 a, Qbar, Q, tmp
    smmulr.w \tmp, \a, \Qbar
    mls.w \a, \tmp, \Q, \a
.endm

// void asm_reduce32(int32_t a[N]);
.global pqcrystals_dilithium_small_asm_reduce32_central_opt_m7
.type pqcrystals_dilithium_small_asm_reduce32_central_opt_m7, %function
.align 2
pqcrystals_dilithium_small_asm_reduce32_central_opt_m7:
    push {r4-r12, lr}


    movw r9, #:lower16:5585133
    movt r9, #:upper16:5585133
    mov.w r10,#769

    movw r12, #32
                // Instructions:    0
                // Expected cycles: 0
                // Expected IPC:    0.00
                //
                // Wall time:     0.09s
                // User time:     0.09s
                //
1:
                                        // Instructions:    32
                                        // Expected cycles: 20
                                        // Expected IPC:    1.60
                                        //
                                        // Wall time:     28.58s
                                        // User time:     28.58s
                                        //
                                        // ----- cycle (expected) ------>
                                        // 0                        25
                                        // |------------------------|----
        ldr.w r14, [r0, #7*4]           // *.............................
        ldr.w r7, [r0, #6*4]            // *.............................
        ldr.w r6, [r0, #5*4]            // .*............................
        ldr.w r5, [r0, #4*4]            // .*............................
        smmulr.w r11, r14, r9           // ..*...........................
        ldr.w r1, [r0, #3*4]            // ..*...........................
        smmulr.w r2, r7, r9             // ...*..........................
        ldr.w r3, [r0, #2*4]            // ...*..........................
        mls.w r11, r11, r10, r14        // ....*.........................
        str.w r11, [r0, #7*4]           // ....*.........................
        mls.w r2, r2, r10, r7           // .....*........................
        ldr.w r11, [r0, #1*4]           // .....*........................
        str.w r2, [r0, #6*4]            // ......*.......................
        smmulr.w r2, r6, r9             // ......*.......................
        smmulr.w r14, r5, r9            // .......*......................
        ldr.w r7, [r0]                  // .......*......................
        mls.w r6, r2, r10, r6           // ........*.....................
        str.w r6, [r0, #5*4]            // ........*.....................
        mls.w r5, r14, r10, r5          // .........*....................
        str.w r5, [r0, #4*4]            // ..........*...................
        smmulr.w r5, r1, r9             // ..........*...................
        smmulr.w r6, r3, r9             // ...........*..................
        mls.w r1, r5, r10, r1           // ............*.................
        str.w r1, [r0, #3*4]            // ............*.................
        mls.w r3, r6, r10, r3           // .............*................
        str.w r3, [r0, #2*4]            // ..............*...............
        smmulr.w r3, r11, r9            // ..............*...............
        smmulr.w r1, r7, r9             // ...............*..............
        mls.w r11, r3, r10, r11         // ................*.............
        str.w r11, [r0, #1*4]           // ................*.............
        mls.w r11, r1, r10, r7          // .................*............
        str r11, [r0], #8*4             // ..................*...........

                                       // ------ cycle (expected) ------>
                                       // 0                        25
                                       // |------------------------|-----
        // ldr.w r1, [r0]              // .......*............'......~...
        // ldr.w r2, [r0, #1*4]        // .....*..............'....~.....
        // ldr.w r3, [r0, #2*4]        // ...*................'..~.......
        // ldr.w r4, [r0, #3*4]        // ..*.................'.~........
        // ldr.w r5, [r0, #4*4]        // .*..................'~.........
        // ldr.w r6, [r0, #5*4]        // .*..................'~.........
        // ldr.w r7, [r0, #6*4]        // *...................~..........
        // ldr.w r8, [r0, #7*4]        // *...................~..........
        // smmulr.w r11, r1, r9        // ...............*....'..........
        // mls.w r1, r11, r10, r1      // .................*..'..........
        // smmulr.w r11, r2, r9        // ..............*.....'..........
        // mls.w r2, r11, r10, r2      // ................*...'..........
        // smmulr.w r11, r3, r9        // ...........*........'..........
        // mls.w r3, r11, r10, r3      // .............*......'..........
        // smmulr.w r11, r4, r9        // ..........*.........'..........
        // mls.w r4, r11, r10, r4      // ............*.......'..........
        // smmulr.w r11, r5, r9        // .......*............'......~...
        // mls.w r5, r11, r10, r5      // .........*..........'........~.
        // smmulr.w r11, r6, r9        // ......*.............'.....~....
        // mls.w r6, r11, r10, r6      // ........*...........'.......~..
        // smmulr.w r11, r7, r9        // ...*................'..~.......
        // mls.w r7, r11, r10, r7      // .....*..............'....~.....
        // smmulr.w r11, r8, r9        // ..*.................'.~........
        // mls.w r8, r11, r10, r8      // ....*...............'...~......
        // str.w r2, [r0, #1*4]        // ................*...'..........
        // str.w r3, [r0, #2*4]        // ..............*.....'..........
        // str.w r4, [r0, #3*4]        // ............*.......'..........
        // str.w r5, [r0, #4*4]        // ..........*.........'..........
        // str.w r6, [r0, #5*4]        // ........*...........'.......~..
        // str.w r7, [r0, #6*4]        // ......*.............'.....~....
        // str.w r8, [r0, #7*4]        // ....*...............'...~......
        // str r1, [r0], #8*4          // ..................*.'..........

        subs r12, #1
        bne 1b
                // Instructions:    0
                // Expected cycles: 0
                // Expected IPC:    0.00
                //
                // Wall time:     0.06s
                // User time:     0.06s
                //

    pop {r4-r12, pc}
